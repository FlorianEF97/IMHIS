"use strict";
(() => {
  const languageButtons = document.querySelectorAll(".lang-btn");
  const germanElements = document.querySelectorAll(".lang-de");
  const englishElements = document.querySelectorAll(".lang-en");
  const altElements = document.querySelectorAll("[data-alt-en]");
  const navToggle = document.querySelector(".nav-toggle");

  const updateToggleLabel = (isOpen) => {
    if (!navToggle) return;
    const suffix = document.documentElement.lang === "en" ? "En" : "De";
    const key = `label${isOpen ? "Close" : "Open"}${suffix}`;
    const label = navToggle.dataset[key];
    if (label) {
      navToggle.setAttribute("aria-label", label);
    }
  };

  const switchLanguage = (lang) => {
    if (!lang || document.documentElement.lang === lang) {
      return;
    }

    const isEnglish = lang === "en";
    document.documentElement.lang = lang;

    germanElements.forEach((element) => {
      element.hidden = isEnglish;
    });

    englishElements.forEach((element) => {
      element.hidden = !isEnglish;
    });

    languageButtons.forEach((button) => {
      button.setAttribute("aria-pressed", String(button.dataset.lang === lang));
    });

    updateToggleLabel(navToggle ? navToggle.classList.contains("open") : false);

    altElements.forEach((element) => {
      if (!element.dataset.altDe) {
        element.dataset.altDe = element.getAttribute("alt") || "";
      }
      const nextAlt = isEnglish ? element.dataset.altEn : element.dataset.altDe;
      if (typeof nextAlt === "string") {
        element.setAttribute("alt", nextAlt);
      }
    });

    try {
      localStorage.setItem("lang", lang);
    } catch (error) {
      // Ignore storage issues (e.g. private mode)
    }

    window.dispatchEvent(new Event("imhis-language-change"));
  };

  document.addEventListener(
    "click",
    (event) => {
      const target = event.target instanceof Element ? event.target : null;
      const button = target ? target.closest(".lang-btn") : null;
      if (button) {
        switchLanguage(button.dataset.lang);
      }
    },
    { passive: true },
  );

  const initialLanguage = (() => {
    try {
      const stored = localStorage.getItem("lang");
      if (stored === "de" || stored === "en") {
        return stored;
      }
    } catch (error) {
      // Ignore storage errors and fall back to navigator language
    }
    return navigator.language && navigator.language.startsWith("en")
      ? "en"
      : "de";
  })();

  switchLanguage(initialLanguage);
})();

(() => {
  const navToggle = document.querySelector(".nav-toggle");
  const navLinks = document.querySelector(".nav-links");
  if (!navToggle || !navLinks) {
    return;
  }

  const mediaQuery = window.matchMedia("(min-width: 768px)");
  let abortController;
  let navController;

  const normalizeOptions = (input, fallbackReason) => {
    if (typeof input === "string") {
      return { reason: input, silent: false };
    }
    if (input && typeof input === "object") {
      return {
        reason: input.reason ?? fallbackReason,
        silent: Boolean(input.silent),
      };
    }
    if (fallbackReason) {
      return { reason: fallbackReason, silent: false };
    }
    return { silent: false };
  };

  const updateToggleLabel = (isOpen) => {
    const suffix = document.documentElement.lang === "en" ? "En" : "De";
    const key = `label${isOpen ? "Close" : "Open"}${suffix}`;
    const label = navToggle.dataset[key];
    if (label) {
      navToggle.setAttribute("aria-label", label);
    }
  };

  const dispatchHeaderResize = () => {
    window.dispatchEvent(new Event("imhis-header-resize"));
  };

  const notifyNavChange = (isOpen, reason) => {
    window.dispatchEvent(
      new CustomEvent("imhis-navigation-change", {
        detail: {
          open: isOpen,
          reason,
          controller: navController ?? null,
        },
      }),
    );
  };

  const isMenuOpen = () => navLinks.classList.contains("open");

  const closeMenu = (input) => {
    const options = normalizeOptions(input, "internal");
    const wasOpen = isMenuOpen();
    navLinks.classList.remove("open");
    navLinks.hidden = !mediaQuery.matches;
    navToggle.classList.remove("open");
    navToggle.setAttribute("aria-expanded", "false");
    updateToggleLabel(false);
    if (abortController) {
      abortController.abort();
      abortController = undefined;
    }
    dispatchHeaderResize();
    if (wasOpen && !options.silent) {
      notifyNavChange(false, options.reason ?? "internal");
    }
  };

  const handleOutsideClick = (event) => {
    const target = event.target instanceof Node ? event.target : null;
    if (target && (navLinks.contains(target) || navToggle.contains(target))) {
      return;
    }
    closeMenu("outside-click");
  };

  const handleEscape = (event) => {
    if (event.key === "Escape") {
      closeMenu("escape");
    }
  };

  const openMenu = (input) => {
    const options = normalizeOptions(input, "internal");
    if (isMenuOpen()) {
      navLinks.hidden = false;
      return;
    }
    navLinks.hidden = false;
    navLinks.classList.add("open");
    navToggle.classList.add("open");
    navToggle.setAttribute("aria-expanded", "true");
    updateToggleLabel(true);
    abortController = new AbortController();
    document.addEventListener("click", handleOutsideClick, {
      signal: abortController.signal,
      passive: true,
    });
    document.addEventListener("keydown", handleEscape, {
      signal: abortController.signal,
    });
    dispatchHeaderResize();
    if (!options.silent) {
      notifyNavChange(true, options.reason ?? "internal");
    }
  };

  const toggleMenu = (input) => {
    if (isMenuOpen()) {
      closeMenu(input);
    } else {
      openMenu(input);
    }
  };

  const handleMediaChange = (event) => {
    if (event.matches) {
      navLinks.hidden = false;
    }
    const wasOpen = isMenuOpen();
    closeMenu({ reason: "media-query", silent: !wasOpen });
    navLinks.hidden = !event.matches;
  };

  navController = Object.freeze({
    open: (options) => openMenu(options),
    close: (options) => closeMenu(options),
    toggle: (options) => toggleMenu(options),
    isOpen: () => isMenuOpen(),
  });

  window.IMHISNavigation = navController;
  window.dispatchEvent(
    new CustomEvent("imhis-navigation-ready", {
      detail: navController,
    }),
  );

  mediaQuery.addEventListener("change", handleMediaChange);

  navToggle.addEventListener("click", (event) => {
    if (event.imhisNavHandled) {
      return;
    }
    if (event.detail > 1) {
      return;
    }
    toggleMenu();
  });
  navLinks.addEventListener("click", (event) => {
    if (event.imhisNavHandled) {
      return;
    }
    const target = event.target instanceof Element ? event.target : null;
    if (target && target.closest("a")) {
      closeMenu("nav-link");
    }
  });

  window.addEventListener("imhis-language-change", () => {
    updateToggleLabel(isMenuOpen());
  });

  window.addEventListener("imhis-navigation-request", (event) => {
    const detail = event.detail || {};
    const action = detail.action;
    const payload = {
      reason: detail.reason ?? "external-request",
      silent: detail.silent === true,
    };
    if (action === "open") {
      openMenu(payload);
    } else if (action === "close") {
      closeMenu(payload);
    } else if (action === "toggle") {
      toggleMenu(payload);
    }
  });

  updateToggleLabel(false);
  navLinks.hidden = !mediaQuery.matches;
})();

(() => {
  const toggleButton = document.getElementById("toggle-sellers");
  const sellerList = document.getElementById("seller-list");
  if (!toggleButton || !sellerList) {
    return;
  }

  let abortController;

  const detachListeners = () => {
    if (abortController) {
      abortController.abort();
      abortController = undefined;
    }
  };

  const setListState = (isOpen) => {
    sellerList.classList.toggle("open", isOpen);
    sellerList.hidden = !isOpen;
    toggleButton.setAttribute("aria-expanded", String(isOpen));

    detachListeners();

    if (isOpen) {
      abortController = new AbortController();
      document.addEventListener("click", handleOutsideClick, {
        signal: abortController.signal,
        passive: true,
      });
      document.addEventListener("keydown", handleEscape, {
        signal: abortController.signal,
      });
    }
  };

  const handleOutsideClick = (event) => {
    const target = event.target instanceof Node ? event.target : null;
    if (
      target &&
      (sellerList.contains(target) || toggleButton.contains(target))
    ) {
      return;
    }
    setListState(false);
  };

  const handleEscape = (event) => {
    if (event.key === "Escape") {
      setListState(false);
    }
  };

  toggleButton.addEventListener("click", () => {
    const nextState = !sellerList.classList.contains("open");
    setListState(nextState);
  });

  setListState(sellerList.classList.contains("open"));
})();

(() => {
  const highlightIMHIS = (root) => {
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    const nodes = [];

    while (walker.nextNode()) {
      const node = walker.currentNode;
      const parent = node.parentElement;
      if (
        !parent ||
        parent.tagName === "SCRIPT" ||
        parent.tagName === "STYLE" ||
        parent.tagName === "STRONG"
      ) {
        continue;
      }
      if (node.nodeValue && node.nodeValue.includes("IMHIS®")) {
        nodes.push(node);
      }
    }

    nodes.forEach((textNode) => {
      const parts = textNode.nodeValue ? textNode.nodeValue.split("IMHIS®") : [];
      if (parts.length === 0) {
        return;
      }
      const fragment = document.createDocumentFragment();
      parts.forEach((part, index) => {
        if (part) {
          fragment.appendChild(document.createTextNode(part));
        }
        if (index < parts.length - 1) {
          const strong = document.createElement("strong");
          strong.textContent = "IMHIS®";
          fragment.appendChild(strong);
        }
      });
      if (textNode.parentNode) {
        textNode.parentNode.replaceChild(fragment, textNode);
      }
    });
  };

  const run = () => {
    highlightIMHIS(document.body);
  };

  document.addEventListener("DOMContentLoaded", run);
  window.addEventListener("imhis-language-change", run);
})();

(() => {
  const docEl = document.documentElement;
  let frameId = 0;
  let lastHeight;

  const parseCssValue = (property, fallback) => {
    const value = parseFloat(
      getComputedStyle(docEl).getPropertyValue(property),
    );
    return Number.isFinite(value) ? value : fallback;
  };

  const measureHeader = () => {
    const header =
      document.querySelector(".site-header") ||
      document.querySelector("header");
    if (!header) {
      return;
    }
    const measured = Math.ceil(header.getBoundingClientRect().height);
    if (!measured) {
      return;
    }

    const min = parseCssValue("--nav-height-min", 56);
    const max = parseCssValue("--nav-height-max", 96);
    const adjusted = Math.min(Math.max(measured, min), max);

    if (adjusted !== lastHeight) {
      docEl.style.setProperty("--nav-height", `${adjusted}px`);
      lastHeight = adjusted;
    }
  };

  const scheduleMeasure = () => {
    if (frameId) {
      cancelAnimationFrame(frameId);
    }
    frameId = requestAnimationFrame(measureHeader);
  };

  window.addEventListener("resize", scheduleMeasure, { passive: true });
  window.addEventListener("load", scheduleMeasure);
  window.addEventListener("imhis-language-change", scheduleMeasure);
  window.addEventListener("imhis-header-resize", scheduleMeasure);

  document.addEventListener("DOMContentLoaded", () => {
    scheduleMeasure();
    const header =
      document.querySelector(".site-header") ||
      document.querySelector("header");
    if (header && "ResizeObserver" in window) {
      const observer = new ResizeObserver(scheduleMeasure);
      observer.observe(header);
    }
  });

  scheduleMeasure();
})();

(() => {
  const cards = document.querySelectorAll("#dimensionen .flip-card");
  if (!cards.length) {
    return;
  }

  let resizeFrame;

  const setCardHeights = () => {
    let maxHeight = 0;
    cards.forEach((card) => {
      const front = card.querySelector(".flip-card-front");
      const back = card.querySelector(".flip-card-back");
      if (!front || !back) {
        return;
      }
      front.style.height = "auto";
      back.style.height = "auto";
      maxHeight = Math.max(maxHeight, front.offsetHeight, back.offsetHeight);
      front.style.height = "";
      back.style.height = "";
    });
    cards.forEach((card) => {
      card.style.height = `${maxHeight}px`;
    });
  };

  const scheduleHeights = () => {
    if (resizeFrame) {
      cancelAnimationFrame(resizeFrame);
    }
    resizeFrame = requestAnimationFrame(setCardHeights);
  };

  scheduleHeights();
  if (document.fonts?.ready) {
    document.fonts.ready.then(scheduleHeights);
  }
  window.addEventListener("resize", scheduleHeights, { passive: true });
  window.addEventListener("imhis-language-change", scheduleHeights);

  let currentCard = null;
  cards.forEach((card) => {
    const button = card.querySelector(".dim-more-btn");
    if (!button) {
      return;
    }
    button.addEventListener("click", () => {
      if (currentCard && currentCard !== card) {
        currentCard.classList.remove("is-flipped");
      }
      card.classList.toggle("is-flipped");
      currentCard = card.classList.contains("is-flipped") ? card : null;
    });
  });

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (!entry.isIntersecting) {
          entry.target.classList.remove("is-flipped");
          if (currentCard === entry.target) {
            currentCard = null;
          }
        }
      });
    },
    { threshold: 0.1 },
  );

  cards.forEach((card) => observer.observe(card));
})();

(() => {
  if (window.__IMHIS_LI_STREAM__) return;
  window.__IMHIS_LI_STREAM__ = true;

  const liViewport = document.getElementById("li-viewport");
  const liTrack = document.getElementById("li-track");
  const liNavPrev = document.querySelector(".li-nav--prev");
  const liNavNext = document.querySelector(".li-nav--next");
  const liUrlList = document.getElementById("li-url-list");

  if (!liViewport || !liTrack || !liUrlList) {
    return;
  }

  const t = (key) => {
    const lang = document.documentElement.lang === "en" ? "en" : "de";
    const dict = {
      loading: { de: "Beitrag wird geladen …", en: "Post is loading…" },
      preview: {
        de: "Vorschau – zum Beitrag auf LinkedIn",
        en: "Preview – view on LinkedIn",
      },
      open: { de: "Öffnen", en: "Open" },
      noPreview: {
        de: "Vorschau nicht möglich.",
        en: "Preview not available.",
      },
      defaultTitle: { de: "LinkedIn-Beitrag", en: "LinkedIn post" },
    };
    return dict[key][lang];
  };

  const getCardHeight = () => {
    const v = getComputedStyle(document.documentElement)
      .getPropertyValue("--li-card-height")
      .trim();
    const num = parseInt(v, 10);
    return Number.isFinite(num) ? num : 560;
  };

  const toURN = (input) => {
    try {
      const u = typeof input === "string" ? new URL(input) : input;
      const full = u.href;
      const urnMatch = full.match(/urn:li:(activity|ugcPost):\d+/);
      if (urnMatch) return urnMatch[0];
      const act = full.match(/activity-(\d{8,})/);
      if (act) return `urn:li:activity:${act[1]}`;
      return null;
    } catch {
      return null;
    }
  };

  const slugTitle = (href) => {
    try {
      const p = new URL(href).pathname;
      const m = p.match(/posts\/[^_]+_([^/]+?)-activity-\d+/);
      let s = m ? m[1] : (p.split("/").pop() || "").replace(/-/g, " ");
      s = s.replace(/^imhis\s+/i, "").replace(/\s+/g, " ").trim();
      return s
        ? s
            .split("-")
            .join(" ")
            .replace(/\b\w/g, (c) => c.toUpperCase())
        : t("defaultTitle");
    } catch {
      return t("defaultTitle");
    }
  };

  const readUrls = () =>
    Array.from(liUrlList.querySelectorAll("[data-li-url]"))
      .map((el) => el.getAttribute("data-li-url"))
      .filter(Boolean);

  const makeStaticCard = (href) => {
    const card = document.createElement("a");
    card.href = href;
    card.target = "_blank";
    card.rel = "noopener noreferrer";
    card.className = "li-card li-static";
    card.innerHTML = `
      <div class="li-static-wrap">
        <span class="li-static-badge">LinkedIn</span>
        <div class="li-static-media"><p class="li-static-title">${slugTitle(href)}</p></div>
      </div>
      <div class="li-static-body"><p>${t("preview")}</p></div>`;
    return card;
  };

  const makeEmbedCard = (href) => {
    const card = document.createElement("div");
    card.className = "li-card";
    const ph = document.createElement("div");
    ph.className = "li-placeholder";
    ph.textContent = t("loading");
    card.appendChild(ph);

    const urn = toURN(href);
    if (!urn) {
      card.innerHTML = `<div class="li-placeholder">${t("noPreview")} <a href="${href}" target="_blank" rel="noopener">${t("open")}</a></div>`;
      return card;
    }

    const targetHeight = getCardHeight();
    const mount = () => {
      const iframe = document.createElement("iframe");
      iframe.className = "li-frame";
      iframe.title = "LinkedIn Post";
      iframe.loading = "lazy";
      iframe.referrerPolicy = "strict-origin-when-cross-origin";
      iframe.height = String(targetHeight);
      iframe.src = `https://www.linkedin.com/embed/feed/update/${encodeURIComponent(urn)}`;
      card.replaceChild(iframe, ph);
    };

    const obs = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) return;
          obs.unobserve(card);
          mount();
        });
      },
      { root: liViewport, rootMargin: "120px" },
    );
    obs.observe(card);

    return card;
  };

  const renderStatic = () => {
    liTrack.innerHTML = "";
    readUrls().forEach((href) => liTrack.appendChild(makeStaticCard(href)));
  };

  const renderEmbeds = () => {
    liTrack.innerHTML = "";
    readUrls().forEach((href) => liTrack.appendChild(makeEmbedCard(href)));
  };

  const scrollByViewport = (dir) => {
    const delta =
      Math.max(0, liViewport.clientWidth - 32) * (dir > 0 ? 1 : -1);
    liViewport.scrollBy({ left: delta, behavior: "smooth" });
  };

  const scheduleEmbeds =
    window.requestIdleCallback || ((cb) => window.setTimeout(cb, 1));

  renderStatic();
  scheduleEmbeds(renderEmbeds);

  const langObserver = new MutationObserver(renderEmbeds);
  langObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["lang"],
  });

  liNavPrev?.addEventListener("click", () => scrollByViewport(-1));
  liNavNext?.addEventListener("click", () => scrollByViewport(1));
})();

(() => {
  const downloadMap = {
    de: "assets/01_IMHIS_Präsentation_PDF_DE.pdf",
    en: "assets/01_IMHIS_Presentation_PDF_EN.pdf",
  };

  const downloadAreas = Array.from(
    document.querySelectorAll(".pitch-download"),
  );

  if (!downloadAreas.length) {
    return;
  }

  const setActiveOption = (container, lang) => {
    const options = container.querySelectorAll(".pitch-download-option");
    options.forEach((option) => {
      const isActive = option.dataset.lang === lang;
      option.classList.toggle("active", isActive);
      if (isActive) {
        option.setAttribute("aria-current", "true");
      } else {
        option.removeAttribute("aria-current");
      }
    });
  };

  const syncWithDocument = () => {
    const lang = document.documentElement.lang === "en" ? "en" : "de";
    downloadAreas.forEach((container) => setActiveOption(container, lang));
  };

  downloadAreas.forEach((container) => {
    const trigger = container.querySelector(".pitch-download-trigger");
    const menu = container.querySelector(".pitch-download-menu");

    if (!trigger || !menu) {
      return;
    }

    trigger.addEventListener("click", (event) => {
      event.stopPropagation();
      const isOpen = container.classList.toggle("is-open");
      trigger.setAttribute("aria-expanded", isOpen ? "true" : "false");
    });

    container.addEventListener("mouseenter", () => {
      container.classList.add("is-hover");
    });

    container.addEventListener("mouseleave", () => {
      container.classList.remove("is-hover");
      if (!container.classList.contains("is-open")) {
        trigger.setAttribute("aria-expanded", "false");
      }
    });

    menu.querySelectorAll(".pitch-download-option").forEach((option) => {
      const lang = option.dataset.lang;
      if (downloadMap[lang]) {
        option.href = downloadMap[lang];
      }
      option.addEventListener("click", () => {
        container.classList.remove("is-open");
        trigger.setAttribute("aria-expanded", "false");
      });
    });
  });

  document.addEventListener("click", (event) => {
    downloadAreas.forEach((container) => {
      if (!container.contains(event.target)) {
        const trigger = container.querySelector(".pitch-download-trigger");
        container.classList.remove("is-open");
        trigger?.setAttribute("aria-expanded", "false");
      }
    });
  });

  syncWithDocument();

  const langObserver = new MutationObserver(syncWithDocument);
  langObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["lang"],
  });
})();

(() => {
  const counters = document.querySelectorAll(".counter-number");
  if (!counters.length) {
    return;
  }

  const reduceMotion = window.matchMedia("(prefers-reduced-motion: reduce)");

  const updateImmediately = () => {
    counters.forEach((el) => {
      const numberSpan = el.querySelector(".number");
      const prefixSpan = el.querySelector(".prefix");
      const targetStr = el.dataset.target ?? "0";
      const target = parseFloat(targetStr);
      const decimals = targetStr.includes(".")
        ? targetStr.split(".")[1].length
        : 0;
      const sign = target >= 0 ? "+" : "-";
      if (prefixSpan) {
        prefixSpan.textContent = sign;
      }
      if (numberSpan) {
        numberSpan.textContent = Math.abs(target).toFixed(decimals);
      }
      el.style.filter = "blur(0)";
      el.style.opacity = "1";
    });
  };

  const animateCounter = (el) => {
    const numberSpan = el.querySelector(".number");
    const prefixSpan = el.querySelector(".prefix");
    if (!numberSpan) {
      return;
    }
    const targetStr = el.dataset.target ?? "0";
    const target = parseFloat(targetStr);
    const decimals = targetStr.includes(".")
      ? targetStr.split(".")[1].length
      : 0;
    const sign = target >= 0 ? "+" : "-";
    if (prefixSpan) {
      prefixSpan.textContent = sign;
    }
    const absTarget = Math.abs(target);
    const duration = 2000;
    const steps = Math.ceil(duration / 16);
    const increment = target / steps;
    let current = 0;
    const update = () => {
      current += increment;
      if (
        (target >= 0 && current >= target) ||
        (target < 0 && current <= target)
      ) {
        numberSpan.textContent = absTarget.toFixed(decimals);
      } else {
        numberSpan.textContent = Math.abs(current).toFixed(decimals);
        requestAnimationFrame(update);
      }
    };
    update();
  };

  if (reduceMotion.matches) {
    updateImmediately();
    return;
  }

  const observer = new IntersectionObserver(
    (entries, obs) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const el = entry.target;
          el.style.filter = "blur(0)";
          el.style.opacity = "1";
          animateCounter(el);
          obs.unobserve(el);
        }
      });
    },
    { threshold: 0.4 },
  );

  observer.observe(counters[0]);

  const revealBtn = document.getElementById("reveal-effects");
  if (revealBtn) {
    let revealed = false;
    revealBtn.addEventListener("click", (event) => {
      event.preventDefault();
      if (revealed) return;
      revealed = true;
      revealBtn.classList.add("revealed");
      const allCounters = Array.from(counters);
      allCounters.forEach((counter, index) => {
        if (index === 0) return;
        setTimeout(
          () => {
            counter.style.filter = "blur(0)";
            counter.style.opacity = "1";
            counter.style.transform = "scale(0.8)";
            counter.style.transition =
              "transform 0.6s ease-out, opacity 0.6s ease-out, filter 0.6s ease-out";
            requestAnimationFrame(() => {
              counter.style.transform = "scale(1)";
            });
            animateCounter(counter);
          },
          (index - 1) * 250,
        );
      });
    });
  }
})();

(() => {
  const btnManufacturer = document.getElementById("toggle-manufacturer");
  const btnClinic = document.getElementById("toggle-clinic");
  const manufacturerCards = document.getElementById("manufacturer-benefits");
  const clinicCards = document.getElementById("clinic-benefits");
  const sectionTitle = document.getElementById("section-title");
  const sectionTitleVariants = sectionTitle
    ? sectionTitle.querySelectorAll("[data-audience]")
    : [];

  if (
    !btnManufacturer ||
    !btnClinic ||
    !manufacturerCards ||
    !clinicCards ||
    !sectionTitle
  ) {
    return;
  }

  const updateSectionTitle = (audience) => {
    if (!sectionTitleVariants.length) return;
    sectionTitleVariants.forEach((variant) => {
      variant.hidden = variant.dataset.audience !== audience;
    });
  };

  const switchAudience = (toManufacturer) => {
    if (toManufacturer) {
      btnManufacturer.classList.add("active");
      btnManufacturer.setAttribute("aria-selected", "true");
      btnClinic.classList.remove("active");
      btnClinic.setAttribute("aria-selected", "false");
      manufacturerCards.style.display = "grid";
      clinicCards.style.display = "none";
      updateSectionTitle("manufacturer");
    } else {
      btnManufacturer.classList.remove("active");
      btnManufacturer.setAttribute("aria-selected", "false");
      btnClinic.classList.add("active");
      btnClinic.setAttribute("aria-selected", "true");
      manufacturerCards.style.display = "none";
      clinicCards.style.display = "grid";
      updateSectionTitle("clinic");
    }
  };

  updateSectionTitle("manufacturer");
  btnManufacturer.addEventListener("click", () => switchAudience(true));
  btnClinic.addEventListener("click", () => switchAudience(false));
})();

(() => {
  const inputTime = document.getElementById("input-time");
  const inputStations = document.getElementById("input-stations");
  const inputWage = document.getElementById("input-wage");
  const inputEmployees = document.getElementById("input-employees");
  const valueTime = document.getElementById("value-time");
  const valueStations = document.getElementById("value-stations");
  const valueWage = document.getElementById("value-wage");
  const valueEmployees = document.getElementById("value-employees");
  const periodMonth = document.getElementById("period-month");
  const periodYear = document.getElementById("period-year");
  const hoursResult = document.getElementById("hours-result");
  const moneyResult = document.getElementById("money-result");
  const vkResult = document.getElementById("vk-result");
  const progressBar = document.getElementById("progress-bar");

  if (
    !inputTime ||
    !inputStations ||
    !inputWage ||
    !inputEmployees ||
    !valueTime ||
    !valueStations ||
    !valueWage ||
    !valueEmployees ||
    !periodMonth ||
    !periodYear ||
    !hoursResult ||
    !moneyResult ||
    !vkResult ||
    !progressBar
  ) {
    return;
  }

  const formatNumber = (num) =>
    num.toLocaleString("de-DE", {
      minimumFractionDigits: 0,
      maximumFractionDigits: 1,
    });

  const updateResults = () => {
    const minutes = parseFloat(inputTime.value);
    const stations = parseFloat(inputStations.value);
    const wage = parseFloat(inputWage.value);
    const employees = parseFloat(inputEmployees.value);
    const days = periodYear.classList.contains("active") ? 365 : 30;

    const hoursPerShift = minutes / 60;
    const totalHours = hoursPerShift * stations * employees * days;
    const totalMoney = totalHours * wage;

    const divisor = periodYear.classList.contains("active") ? 2080 : 160;
    const totalVK = totalHours / divisor;

    hoursResult.textContent = formatNumber(totalHours);
    moneyResult.textContent = formatNumber(totalMoney);
    vkResult.textContent = formatNumber(totalVK);

    const maxHours = periodYear.classList.contains("active") ? 4000 : 350;
    const maxMoney = periodYear.classList.contains("active") ? 200000 : 20000;
    const ratio = Math.max(
      Math.min(totalHours / maxHours, 1),
      Math.min(totalMoney / maxMoney, 1),
    );
    progressBar.style.width = `${(ratio * 100).toFixed(2)}%`;

    valueTime.textContent = minutes;
    valueStations.textContent = stations;
    valueWage.textContent = wage;
    valueEmployees.textContent = employees;
  };

  inputTime.addEventListener("input", updateResults);
  inputStations.addEventListener("input", updateResults);
  inputWage.addEventListener("input", updateResults);
  inputEmployees.addEventListener("input", updateResults);

  const switchPeriod = (toYear) => {
    if (toYear) {
      periodYear.classList.add("active");
      periodMonth.classList.remove("active");
    } else {
      periodMonth.classList.add("active");
      periodYear.classList.remove("active");
    }
    updateResults();
  };

  periodMonth.addEventListener("click", () => switchPeriod(false));
  periodYear.addEventListener("click", () => switchPeriod(true));

  updateResults();
})();

(() => {
  const backToTopButton = document.querySelector(".back-to-top");
  if (!backToTopButton) {
    return;
  }

  const toggleBackToTop = () => {
    const shouldShow = window.scrollY > window.innerHeight;
    backToTopButton.classList.toggle("is-visible", shouldShow);
    backToTopButton.setAttribute("aria-hidden", shouldShow ? "false" : "true");
  };

  toggleBackToTop();
  window.addEventListener("scroll", toggleBackToTop, { passive: true });

  backToTopButton.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
})();
